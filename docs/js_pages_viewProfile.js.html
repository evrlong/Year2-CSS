<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: js/pages/viewProfile.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: js/pages/viewProfile.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file ViewProfile.js
 * @description Handles logic for the profile page, including fetching profile data,
 * displaying user posts, and managing follow/unfollow functionality.
 */

// API imports
import { fetchUserProfile, fetchUserPosts } from '../api/fetch.js';
import { singleProfileUrl, defaultProfileParams } from '../api/api.js';
import { getDefaultHeaders } from '../api/config.js';
import { checkIfFollowing } from '../api/profile/checkIfFollowing.js';

// UI components and handlers
import { loadNavbar } from '../../components/navbar.js';
import { loadFooter } from '../../components/footer.js';
import { addCreateToHtml } from '../../components/createPost.js';
import { renderFollowers, renderFeedPosts } from '../utils/render.js';
import { setupEditPostHandlers } from '../utils/handlers/editPostHandlers.js';

// Authentication
import { requireAuth } from '../auth/auth.js';

// Initialize layout and authentication
loadNavbar();
loadFooter();
requireAuth();
setupEditPostHandlers();

// Global state
let userPosts = []; // Store user posts

// Setup post creation UI
addCreateToHtml(renderFeedPosts, userPosts);

// Get user info from query parameters and localStorage
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const userId = urlParams.get('user');

const localStorageUser = localStorage.getItem('profileData');
const parsedUser = JSON.parse(localStorageUser);
const currentUserName = parsedUser.name;

// Update document title and page header
document.title = `SOME | ${userId}'s Profile`;
const profileTitle = document.getElementById('profileTitle');
profileTitle.innerHTML = `${userId}'s feed`;

// Fetch and display profile and posts
fetchUserProfile(userId);

fetchUserPosts(userId).then((posts) => {
  // Avoid duplicates
  const newPosts = posts.filter(
    (post) => !userPosts.some((existingPost) => existingPost.id === post.id),
  );

  if (newPosts.length > 0) {
    userPosts.push(...newPosts);
    renderFeedPosts(userPosts);
  }
});

// Follow button logic
const followButton = document.getElementById('followButton');
let isFollowing = await checkIfFollowing(userId); // Must be in top-level async context or inside IIFE

/**
 * Updates the follow button's appearance and state
 * based on whether the current user is following the profile.
 */
function updateFollowButton() {
  if (userId === currentUserName) {
    followButton.innerHTML = '&lt;i class="fa-solid fa-crown">&lt;/i>';
    followButton.classList.remove(
      'bg-green-500',
      'bg-red-500',
      'cursor-default',
      'hover:bg-green-600',
    );
    followButton.classList.add('bg-yellow-500', 'cursor-default');
    followButton.disabled = true;
    return;
  }

  followButton.innerHTML = isFollowing
    ? '&lt;i class="fa-solid fa-user-minus">&lt;/i>'
    : '&lt;i class="fa-solid fa-user-plus">&lt;/i>';

  followButton.classList.remove('bg-yellow-500', 'cursor-default');
  followButton.classList.toggle('bg-green-500', !isFollowing);
  followButton.classList.toggle('bg-red-500', isFollowing);
  followButton.disabled = false;
}

// Initial update of follow button
updateFollowButton();

/**
 * Event listener for follow/unfollow button click
 */
followButton.addEventListener('click', async () => {
  try {
    followButton.disabled = true; // Prevent multiple clicks

    if (isFollowing) {
      // Unfollow logic
      const unfollowResponse = await fetch(
        `${singleProfileUrl}/${userId}/unfollow`,
        {
          method: 'PUT',
          headers: getDefaultHeaders(),
        },
      );

      if (!unfollowResponse.ok) {
        throw new Error('Failed to unfollow user');
      }

      isFollowing = false;
    } else {
      // Follow logic
      const followResponse = await fetch(
        `${singleProfileUrl}/${userId}/follow`,
        {
          method: 'PUT',
          headers: getDefaultHeaders(),
        },
      );

      if (!followResponse.ok) {
        throw new Error('Failed to follow user');
      }

      isFollowing = true;
    }

    updateFollowButton();

    // Fetch and render updated profile data (for updated follower count, etc.)
    const queryString = new URLSearchParams(defaultProfileParams).toString();
    const url = `${singleProfileUrl}/${userId}?${queryString}`;
    const updatedProfile = await fetch(url, {
      method: 'GET',
      headers: getDefaultHeaders(),
    });

    if (!updatedProfile.ok) {
      throw new Error('Failed to fetch updated profile');
    }

    const updatedData = await updatedProfile.json();
    renderFollowers(updatedData.data.followers || []);
  } catch (error) {
    console.error('Error following/unfollowing user:', error);
    alert('Something went wrong. Please try again.');
  } finally {
    followButton.disabled = false;
  }
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-fetch.html">fetch</a></li><li><a href="module-login.html">login</a></li><li><a href="module-register.html">register</a></li></ul><h3>Events</h3><ul><li><a href="global.html#event:DOMContentLoaded">DOMContentLoaded</a></li></ul><h3>Global</h3><ul><li><a href="global.html#API_BASE_URL">API_BASE_URL</a></li><li><a href="global.html#addCreateToHtml">addCreateToHtml</a></li><li><a href="global.html#addLogoutListeners">addLogoutListeners</a></li><li><a href="global.html#apiKey">apiKey</a></li><li><a href="global.html#checkIfFollowing">checkIfFollowing</a></li><li><a href="global.html#closeForm">closeForm</a></li><li><a href="global.html#createFollowerCard">createFollowerCard</a></li><li><a href="global.html#createFollowingCard">createFollowingCard</a></li><li><a href="global.html#createPostCard">createPostCard</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#decodeToken">decodeToken</a></li><li><a href="global.html#getDefaultHeaders">getDefaultHeaders</a></li><li><a href="global.html#getPostData">getPostData</a></li><li><a href="global.html#getPostUrl">getPostUrl</a></li><li><a href="global.html#handleError">handleError</a></li><li><a href="global.html#handleFeedback">handleFeedback</a></li><li><a href="global.html#handleSearch">handleSearch</a></li><li><a href="global.html#initCreatePost">initCreatePost</a></li><li><a href="global.html#isLoggedIn">isLoggedIn</a></li><li><a href="global.html#loadEditPost">loadEditPost</a></li><li><a href="global.html#loadFooter">loadFooter</a></li><li><a href="global.html#loadNavbar">loadNavbar</a></li><li><a href="global.html#logOut">logOut</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#openEditPopup">openEditPopup</a></li><li><a href="global.html#renderFeedPosts">renderFeedPosts</a></li><li><a href="global.html#renderFollowers">renderFollowers</a></li><li><a href="global.html#renderFollowing">renderFollowing</a></li><li><a href="global.html#renderProfileData">renderProfileData</a></li><li><a href="global.html#resetForm">resetForm</a></li><li><a href="global.html#setupEditPostHandlers">setupEditPostHandlers</a></li><li><a href="global.html#setupInputCounter">setupInputCounter</a></li><li><a href="global.html#setupMenuToggle">setupMenuToggle</a></li><li><a href="global.html#toggleVisibility">toggleVisibility</a></li><li><a href="global.html#updateFollowButton">updateFollowButton</a></li><li><a href="global.html#updateNavbar">updateNavbar</a></li><li><a href="global.html#validateConfirmPassword">validateConfirmPassword</a></li><li><a href="global.html#validateInput">validateInput</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri May 16 2025 23:34:35 GMT+0200 (sentraleuropeisk sommertid)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
